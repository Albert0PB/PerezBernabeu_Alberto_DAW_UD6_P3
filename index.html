<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>My Docs</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/fontawesome.min.css" rel="stylesheet">
        <link href="css/brands.min.css" rel="stylesheet">
        <link href="css/solid.min.css" rel="stylesheet">
        <link href="css/v4-font-face.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body class="homepage">
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href=".">My Docs</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#practica-6-3-servidor-web-con-usuarios-autenticados-mediante-servicio-de-directorio-ldap" class="nav-link">Práctica 6-3. Servidor web con usuarios autenticados mediante servicio de directorio (LDAP)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#despliegue-con-nginx-openldap-y-daemon-de-autenticacion-ldap" class="nav-link">Despliegue con Nginx, OpenLDAP y daemon de autenticación LDAP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#despliegue-con-php-y-apache-con-ldap" class="nav-link">Despliegue con PHP y Apache con LDAP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-6-3-servidor-web-con-usuarios-autenticados-mediante-servicio-de-directorio-ldap">Práctica 6-3. Servidor web con usuarios autenticados mediante servicio de directorio (LDAP)</h1>
<p>Para esta práctica, utilizaremos 'docker-compose' para crear una 
aplicación web con usuarios autenticados mediante LDAP. </p>
<p>En mi caso, crearé toda la estructura de archivos y directorios 
sobre el directorio "Home" de mi usuario.</p>
<h2 id="despliegue-con-nginx-openldap-y-daemon-de-autenticacion-ldap">Despliegue con Nginx, OpenLDAP y daemon de autenticación LDAP</h2>
<p>En primer lugar crearemos los directorios y archivos que compondrán 
el proyecto. En mi caso, ejecuto:</p>
<pre><code class="language-console">cd 
mkdir -p practica6-3/app
mkdir practica6-3/conf
touch practica6-3/app/index.html
touch practica6-3/conf/ldap_nginx.conf
</code></pre>
<p>Con un editor de texto agregamos el contenido de los archivos 'index.html' 
y 'ldap_nginx.conf'. El contenido de 'index.html' será uno sencillo:</p>
<pre><code class="language-html">&lt;html&gt;
    &lt;body&gt;
        &lt;h1&gt;¡Hola Mundo!&lt;/h1&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>El contenido de 'ldap_nginx.conf' será:</p>
<pre><code class="language-nginx">server {
      listen 8080;

      location = / {
         auth_request /auth-proxy;
      }

      location = /auth-proxy {
         internal;

         proxy_pass http://nginx-ldap:8888;
         proxy_set_header X-Ldap-URL &quot;ldap://openldap:1389&quot;;
         proxy_set_header X-Ldap-BaseDN &quot;dc=example,dc=org&quot;;
         proxy_set_header X-Ldap-BindDN &quot;cn=admin,dc=example,dc=org&quot;;
         proxy_set_header X-Ldap-BindPass &quot;adminpassword&quot;;
      }
   }
</code></pre>
<p>Y por último crearemos el archivo 'docker-compose.yml' 
(practica6-3/docker-compose.yml) con el siguiente contenido: </p>
<pre><code class="language-yaml">version: '2'

services:
  nginx-ldap:  # 
    image: bitnami/nginx-ldap-auth-daemon-archived # 
    ports: # 
      - 8888:8888
  nginx: # 
    image: bitnami/nginx
    ports: 
     - 8080:8080
    volumes: # 
     - ./app:/app
     - ./conf/ldap_nginx.conf:/opt/bitnami/nginx/conf/server_blocks/ldap_nginx.conf
  openldap: # 
    image: bitnami/openldap
    ports:
      - '1389:1389'    
    environment: # 
      - LDAP_ADMIN_USERNAME=admin
      - LDAP_ADMIN_PASSWORD=adminpassword
      - LDAP_USERS=customuser
      - LDAP_PASSWORDS=custompassword
</code></pre>
<p>Y ya sólo queda ejecutar:</p>
<pre><code class="language-console">docker compose up
</code></pre>
<p>Si accedemos al puerto '8080' de la IP de la máquina donde hayamos creado la 
aplicación a través del navegador, se nos pedirá que nos autentifiquemos: </p>
<p><img alt="Autenticación" src="images/autenticacion_nginx_lpad.png" /></p>
<p>Una vez introducimos los datos de autenticación, se nos permitirá acceder 
a la página:</p>
<p><img alt="Página" src="images/pagina_nginx_lpad.png" /></p>
<h2 id="despliegue-con-php-y-apache-con-ldap">Despliegue con PHP y Apache con LDAP</h2>
<p>Para esta segunda parte de la práctica, he borrado todos los archivos y 
directorios dentro de '~/practica6-3', ya que será este mismo directorio 
en el que realice el despliegue con PHP y Apache. Antes de eliminar los 
archivos, he detenido la ejecución de los contenedores creados en el 
anterior apartado con:</p>
<pre><code class="language-console">docker compose down
</code></pre>
<p>Ahora, con los contenedores detenidos y el directorio limpio, vamos a 
comenzar creando un 'index.php'. También tendrá un contenido muy simple:</p>
<pre><code class="language-php">&lt;?php
echo &quot;Hola, usuario autenticado por LDAP&quot;;
?&gt;
</code></pre>
<p>También crearemos un directorio 'Docker' y, dentro de él, un archivo Dockerfile 
con el siguiente contenido:</p>
<pre><code class="language-dockerfile">FROM php:7-apache
RUN a2enmod authnz_ldap
COPY Docker/ldap-demo.conf /etc/apache2/conf-enabled/
WORKDIR /var/www/html/demo
COPY Docker/.htaccess ./.htaccess
COPY index.php ./
</code></pre>
<p>Dentro del directorio 'Docker' también crearemos un archivo 'ldap-demo.conf', 
que contendrá una serie de directivas que componen la configuración LDAP. 
Su contenido será:</p>
<pre><code class="language-conf">PassEnv LDAP_BIND_ON
PassEnv LDAP_PASSWORD
PassEnv LDAP_URL
&lt;AuthnProviderAlias ldap demo&gt;
    AuthLDAPBindDN ${LDAP_BIND_ON}
    AuthLDAPBindPassword ${LDAP_PASSWORD}
    AuthLDAPURL ${LDAP_URL}
&lt;/AuthnProviderAlias&gt; 
</code></pre>
<p>Y un último archivo en 'Docker' con nombre '.htaccess' y contenido:</p>
<pre><code class="language-txt">AuthBasicProvider demo
AuthType Basic
AuthName &quot;Protected Area&quot;
Require valid-user
</code></pre>
<p>Ahora construiremos la imagen ejecutando el siguiente comando de Docker:</p>
<pre><code class="language-console">docker build . \
    -t docker-ldap \
    -f ./Docker/dockerfile
</code></pre>
<p>Por último ejecutaremos un comando 'docker run' utilizando un servicio público 
de internet para pruebas. El comando a ejecutar completo es:</p>
<pre><code class="language-console">docker run \
    -p 3000:80 \
    --name ldap_demo \
    -e LDAP_BIND_ON='uid=admin,cn=users,cn=accounts,dc=demo1,dc=freeipa,dc=org' \
    -e LDAP_PASSWORD='Secret123' \
    -e LDAP_URL='LDAP://ipa.demo1.freeipa.org' \
    docker-ldap
</code></pre>
<p>Y si accedemos a la IP de la máquina corriendo la imagen en el puerto 3000 y 
especificando la ruta '/demo', se nos requerirán los datos de autenticación:</p>
<p><img alt="Autenticación Apache" src="images/autenticacion_apache.png" /></p>
<p>Le indicamos los datos de autenticación y podremos acceder a la página:</p>
<p><img alt="Página Apache" src="images/pagina_apache.png" /></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js"></script>
        <script src="search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.6.1
Build Date UTC : 2025-02-27 22:10:37.714648+00:00
-->
